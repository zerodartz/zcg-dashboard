<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Zcash Community Grants Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
/* Base Layout */
body { margin: 0 auto; font-family: "Inter", Arial, sans-serif; background: #fdfdfd; color: #222; display: flex; width: 75%; max-width: 2000px; }
.sidebar { width: 180px; background: #fdfdfd; border-right: 1px solid #d0d0d0; display: flex; flex-direction: column; padding: 20px; }
.sidebar h2 { color: #ffbb00; font-size: 1.4em; margin-bottom: 30px; }
.nav-item { padding: 10px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; font-weight: 500; }
.nav-item:hover, .nav-item.active { background: #ffbb00; color: white; }
.main { flex: 1; display: flex; flex-direction: column; }
.topbar { background: #fdfdfd; padding: 10px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.search-box { flex: 1; padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 0.95em; }
.stats { display: flex; gap: 20px; padding: 12px; flex-wrap: wrap; }
.stat { flex: 1 1 120px; background: rgb(243, 243, 243); border: 1px solid #d0d0d0; border-radius: 8px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center; }
.stat h3 { font-size: 1em; margin-bottom: 5px; color: #666; }
.stat p { font-size: 1.2em; font-weight: bold; }
.charts-row { display: flex; gap: 20px; padding: 0 32px 20px 20px;}
.chart-container, .pie-container { background: rgb(243, 243, 243)fd; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); overflow: hidden;}
.chart-container {
  flex: 3;
  max-height: 660px; /* 60% of screen height */
}
.chart-container canvas {
  height: 100% !important;
}
.pie-container { flex: 1; }
.grants-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 0 20px 20px; }
.grants-grid.full-width { display: block; margin-top: 20px; margin-right: 30px; }
.grants-grid.full-width .grant-card { width: 100%; margin-bottom: 15px; }
.grant-card { background: rgb(243, 243, 243); border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s ease; }
.grant-card:hover { transform: translateY(-3px); }
.grant-title { font-weight: bold; margin-bottom: 8px; }

/* Glow effects (2px border) */
.glow-green { box-shadow: 0 0 6px 3px rgba(115, 225, 96, 0.2); border: 1px solid rgba(115, 225, 96, 0.7); }
.glow-yellow { box-shadow: 0 0 6px 3px rgba(255, 193, 7, 0.2); border: 1px solid rgba(255, 193, 7, 0.7); }

/* Status label */
.status-label { margin-bottom: 8px; font-weight: bold; }

/* Progress bar */
.progress-bar { background: #eee; border-radius: 4px; height: 8px; margin-top: 4px; margin-bottom: 8px; }
.progress { background: rgb(115, 225, 96); height: 100%; border-radius: 4px; }

/* Filters bar */
.filters-bar { display: none; gap: 10px; align-items: center; margin: 10px 20px; flex-wrap: wrap; }
.filter-btn { padding: 6px 14px; border-radius: 20px; border: 1px solid #d6d6d6; background: rgb(238, 238, 238); cursor: pointer; font-size: 0.85em; }
.filter-btn.active { background: #f5b949; color: white; border-color: #ef993d; }
#sortSelect { padding: 5px; border-radius: 6px; border: 1px solid #ddd; }

/* Chart filter buttons */
.chart-filters { display: flex; gap: 8px; margin-bottom: 10px; }
.chart-filter-btn { padding: 4px 10px; border-radius: 20px; border: 1px solid #e2e2e2; background: rgb(236, 236, 236); cursor: pointer; font-size: 0.8em; }
.chart-filter-btn.active { background: #ff9800; color: white; border-color: #ff9800; }

/* Modal */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.2); backdrop-filter: blur(8px); justify-content: center; align-items: center; }
.modal-content { background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); border-radius: 15px; padding: 20px; width: 70%; height: 70%; overflow-y: auto; position: relative; box-shadow: 0 20px 40px rgba(0,0,0,0.25); }
.close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5em; cursor: pointer; }

/* Tablet breakpoint - triggers earlier at 1280px */
@media (max-width: 1280px) {
  body { flex-direction: column; }
  .sidebar { width: 100%; flex-direction: row; justify-content: space-around; padding: 10px; }
  .sidebar h2 { display: none; }
  .nav-item { margin-bottom: 0; padding: 8px 12px; font-size: 0.9em; }
}

/* Mobile breakpoint */
@media (max-width: 768px) {
  .stats { flex-direction: column; gap: 10px; padding: 10px; }
  .charts-row { flex-direction: column; padding: 10px; }
  .chart-container, .pie-container { width: 100%; margin-bottom: 15px; }
  .grants-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); padding: 10px; }
}
</style>
</head>
<body>
<div class="sidebar">
  <h2>ZCG</h2>
  <div id="nav-dashboard" class="nav-item active">Dashboard</div>
  <div id="nav-grants" class="nav-item">Grants</div>
</div>
<div class="main">
  <div class="topbar">
    <input type="text" id="search" class="search-box" placeholder="Search grants...">
  </div>

  <div class="stats" id="stats"></div>

  <div class="charts-row" id="chartsRow">
    <div class="chart-container">
      <div class="chart-filters" id="chartFilters">
        <button class="chart-filter-btn" data-range="3m">3M</button>
        <button class="chart-filter-btn" data-range="6m">6M</button>
        <button class="chart-filter-btn" data-range="12m">12M</button>
        <button class="chart-filter-btn" data-range="ytd">YTD</button>
        <button class="chart-filter-btn active" data-range="max">Max</button>
      </div>
      <canvas id="payoutsChart"></canvas>
    </div>
    <div class="pie-container"><canvas id="categoryPie"></canvas></div>
  </div>

  <div class="filters-bar" id="filtersBar">
    <button class="filter-btn active" data-status="all">All</button>
    <button class="filter-btn" data-status="completed">Completed</button>
    <button class="filter-btn" data-status="inprogress">In Progress</button>
    <button class="filter-btn active" data-size="all">All Sizes</button>
    <button class="filter-btn" data-size="small">Small (&lt; $50k)</button>
    <button class="filter-btn" data-size="medium">Medium ($50kâ€“$200k)</button>
    <button class="filter-btn" data-size="big">Big (&gt; $200k)</button>
    <select id="sortSelect">
      <option value="newest">Newest payment</option>
      <option value="oldest">Oldest payment</option>
    </select>
  </div>

  <div id="grantsCount" style="margin: 0 20px 10px; font-weight: bold;"></div>

  <div class="grants-grid" id="grantsGrid"></div>
</div>

<div id="grantModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <div id="modalDetails"></div>
  </div>
</div>

<script>
const DASHBOARD_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8usf0eqwhPTGxP_j_-AWCPu05PlOonPUeYnlXE5NcipAm73Vz-BHEa33wgeldeROioU9_-wBChRo-/pub?gid=7542155&single=true&output=csv";
const GRANTS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8usf0eqwhPTGxP_j_-AWCPu05PlOonPUeYnlXE5NcipAm73Vz-BHEa33wgeldeROioU9_-wBChRo-/pub?gid=1871548102&single=true&output=csv";
const FUNDS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8usf0eqwhPTGxP_j_-AWCPu05PlOonPUeYnlXE5NcipAm73Vz-BHEa33wgeldeROioU9_-wBChRo-/pub?gid=1521309413&single=true&output=csv";

let monthlyStats = [];
let fullMonthlyStats = [];
let payoutsChart;
let categoryPieChart;
let grants = [];
let currentStatusFilter = "all";
let currentSizeFilter = "all";
let currentSort = "newest";

const cleanNumber = (val) => parseFloat((val || "0").toString().replace(/[$,]/g, "")) || 0;

const ctx1 = document.getElementById("payoutsChart").getContext("2d");

function createGradient(ctx, color) {
  const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
  gradient.addColorStop(0, color.replace("1)", "0.8)")); // top with 0.6 opacity
  gradient.addColorStop(1, color.replace("1)", "0.1)"));   // bottom transparent
  return gradient;
}

const gradientGreen = createGradient(ctx1, "rgba(100, 220, 110, 1)");
const gradientOrange = createGradient(ctx1, "rgba(245, 200, 30, 1)");

function loadData() {
  fetch(DASHBOARD_CSV).then(r => r.text()).then(csv => {
    const data = Papa.parse(csv).data;
    const getValue = (label) => {
      const row = data.find(r => r[0] && r[0].includes(label));
      return row ? row[1] : "N/A";
    };
    renderStats({
      "Total Grants Approved": getValue("Total USD value of grants approved"),
      "Grants Paid Out": getValue("USD value of grant milestones paid out so far"),
      "Future Liabilities": getValue("Future grant liabilities"),
      "Current USD Balance Available": getValue("Current USD balance"),
      "Current Value of ZEC Available": getValue("USD value of Current ZEC balance"),
      "Current Budget Available ZEC": getValue("Current ZEC balance"),
      "ZEC Price": getValue("ZECUSD price")
    });
    document.getElementById("filtersBar").style.display = "flex";
  });

  fetch(GRANTS_CSV).then(r => r.text()).then(csv => {
    const rows = Papa.parse(csv, { header: true }).data;
    const projectMap = {};
    const monthlyMap = {};

    rows.forEach(row => {
      if (!row["Project"]) return;
      const project = row["Project"];
      const grantee = row["Grantee"] || "Unknown";
      const category = row["Category (as determined by ZCG)"] || "Uncategorized";
      const amount = cleanNumber(row["Amount (USD)"]);
      const paidOut = row["Paid Out"];
      const milestone = row["Milestone"];

      if (!projectMap[project]) {
        projectMap[project] = { title: project, grantee, category, awarded: 0, paid: 0, milestones: [], milestonesCompleted: 0, lastPayment: "" };
      }
      projectMap[project].awarded += amount;
      projectMap[project].milestones.push(milestone);

      if (paidOut) {
        projectMap[project].paid += amount;
        projectMap[project].milestonesCompleted++;
        if (!projectMap[project].lastPayment || new Date(paidOut) > new Date(projectMap[project].lastPayment)) {
          projectMap[project].lastPayment = paidOut;
        }
        const date = new Date(paidOut);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,"0")}`;
        if (!monthlyMap[monthKey]) monthlyMap[monthKey] = { amount: 0, milestones: 0 };
        monthlyMap[monthKey].amount += amount;
        monthlyMap[monthKey].milestones++;
      }
    });

    grants = Object.values(projectMap);
    monthlyStats = Object.entries(monthlyMap).sort(([a],[b]) => a.localeCompare(b))
      .map(([month, data]) => ({ month, ...data }));
    fullMonthlyStats = [...monthlyStats];

    renderGrants();
    renderLineChart(monthlyStats);
  });

  fetch(FUNDS_CSV).then(r => r.text()).then(csv => {
    const rows = Papa.parse(csv, { header: true }).data;
    const categoryTotals = {};
    rows.forEach(row => {
      const cat = (row["Grant Classification"] || "").trim();
      const amount = cleanNumber(row["Category Amount"]);
      if (cat && amount > 0) categoryTotals[cat] = amount;
    });
    renderPieChart(categoryTotals);
  });
}

function initCharts() {
  const ctx1 = document.getElementById("payoutsChart").getContext("2d");
  payoutsChart = new Chart(ctx1, {
  type: "line",
  data: {
    labels: [],
    datasets: [
      {
        label: "Milestones Completed",
        data: [],
        borderColor: "#ff9800",
        backgroundColor: gradientOrange,
        fill: true,
        tension: 0.2,
        yAxisID: "y1"
      },
      {
        label: "Payouts (USD)",
        data: [],
        borderColor: "#73e160",
        backgroundColor: gradientGreen,
        fill: true,
        tension: 0.2,
        yAxisID: "y2"
      }
    ]
  },
  options: {
  responsive: true,
  maintainAspectRatio: false,
  interaction: { mode: "index", intersect: false },
  stacked: false,
  layout: {
    padding: { bottom: 30 } // extra space for labels
  },
  scales: {
    x: {
      ticks: {
        maxRotation: 60, // tilt labels
        minRotation: 45, // minimum tilt
        autoSkip: true,  // skip some labels if too many
        maxTicksLimit: 12 // limit number of ticks
      }
    },
    y1: { type: "linear", position: "left" },
    y2: { type: "linear", position: "right", grid: { drawOnChartArea: false } }
  }
  }
});

  const ctx2 = document.getElementById("categoryPie").getContext("2d");
  categoryPieChart = new Chart(ctx2, { type: "pie", data: { labels: [], datasets: [{ data: [] }] }, options: { responsive: true } });
}

function renderStats(statsObj) {
  document.getElementById("stats").innerHTML = Object.entries(statsObj).map(([k,v]) =>
    `<div class="stat"><h3>${k}</h3><p>${v}</p></div>`).join("");
}

function renderGrants(filter="") {
  const grid = document.getElementById("grantsGrid");
  grid.innerHTML = "";

  let filtered = grants.filter(g =>
    (g.title || "").toLowerCase().includes(filter) ||
    (g.grantee || "").toLowerCase().includes(filter) ||
    (g.category || "").toLowerCase().includes(filter)
  );

  filtered = filtered.filter(g => {
    const totalMilestones = g.milestones.length;
    const isCompleted = totalMilestones > 0 && g.milestonesCompleted === totalMilestones;
    if (currentStatusFilter === "completed" && !isCompleted) return false;
    if (currentStatusFilter === "inprogress" && isCompleted) return false;
    return true;
  });

  filtered = filtered.filter(g => {
    if (currentSizeFilter === "small") return g.awarded < 50000;
    if (currentSizeFilter === "medium") return g.awarded >= 50000 && g.awarded <= 200000;
    if (currentSizeFilter === "big") return g.awarded > 200000;
    return true;
  });

  filtered.sort((a, b) => {
    const dateA = a.lastPayment ? new Date(a.lastPayment) : null;
    const dateB = b.lastPayment ? new Date(b.lastPayment) : null;
    if (!dateA && !dateB) return 0;
    if (!dateA) return 1;
    if (!dateB) return -1;
    return currentSort === "newest" ? dateB - dateA : dateA - dateB;
  });

  document.getElementById("grantsCount").textContent = `${filtered.length} grant${filtered.length !== 1 ? "s" : ""} found`;

  filtered.forEach(g => {
    const totalMilestones = g.milestones.length;
    const percentComplete = totalMilestones > 0 ? Math.round((g.milestonesCompleted / totalMilestones) * 100) : 0;
    let status = "In Progress";
    let glowClass = "glow-yellow";
    if (totalMilestones > 0 && g.milestonesCompleted === totalMilestones) {
      status = "Completed";
      glowClass = "glow-green";
    }
    const card = document.createElement("div");
    card.className = `grant-card ${glowClass}`;
    card.innerHTML = `
      <div class="grant-title">${g.title}</div>
      <div class="status-label">Status: ${status}</div>
      <div><strong>Category:</strong> ${g.category}</div>
      <div><strong>Grantee:</strong> ${g.grantee}</div>
      <div><strong>Grant budget:</strong> $${g.awarded.toLocaleString()}</div>
      <div><strong>Paid:</strong> $${g.paid.toLocaleString()}</div>
      <div><strong>Milestones Completed:</strong> ${g.milestonesCompleted} / ${totalMilestones} (${percentComplete}%)</div>
      <div class="progress-bar"><div class="progress" style="width:${percentComplete}%;"></div></div>
      <div><strong>Last payment:</strong> ${g.lastPayment}</div>
    `;
    card.onclick = () => openModal(g);
    grid.appendChild(card);
  });
}

function renderLineChart(data) {
  payoutsChart.data.labels = data.map(p => p.month);
  payoutsChart.data.datasets[0].data = data.map(m => m.milestones);
  payoutsChart.data.datasets[1].data = data.map(p => p.amount);
  payoutsChart.update();
}

function filterLineChart(range) {
  let filtered = [...fullMonthlyStats];
  const now = new Date();
  if (range === "3m") filtered = filtered.slice(-3);
  else if (range === "6m") filtered = filtered.slice(-6);
  else if (range === "12m") filtered = filtered.slice(-12);
  else if (range === "ytd") filtered = filtered.filter(d => d.month.startsWith(now.getFullYear().toString()));
  payoutsChart.data.labels = filtered.map(p => p.month);
  payoutsChart.data.datasets[0].data = filtered.map(m => m.milestones);
  payoutsChart.data.datasets[1].data = filtered.map(p => p.amount);
  payoutsChart.update();
}

function renderPieChart(categoryTotals) {
  if (categoryPieChart) categoryPieChart.destroy();
  const ctx2 = document.getElementById("categoryPie").getContext("2d");
  categoryPieChart = new Chart(ctx2, {
    type: "pie",
    data: { labels: Object.keys(categoryTotals), datasets: [{ data: Object.values(categoryTotals), backgroundColor: ["#ff9800","#4f46e5","#4caf50","#9e9e9e","#2196f3","#f44336","#9c27b0","#00bcd4","#8bc34a","#ffc107","#795548","#607d8b", "#FFC0CB"] }] }
  });
}

function openModal(g) {
  document.getElementById("modalDetails").innerHTML = `
    <h2>${g.title}</h2>
    <div><strong>Grantee:</strong> ${g.grantee}</div>
    <div><strong>Category:</strong> ${g.category}</div>
    <div><strong>Grant budget:</strong> $${g.awarded.toLocaleString()}</div>
    <div><strong>Paid:</strong> $${g.paid.toLocaleString()}</div>
    <div><strong>Milestones Completed:</strong> ${g.milestonesCompleted}</div>
    <div><strong>Last payment:</strong> ${g.lastPayment}</div>
  `;
  document.getElementById("grantModal").style.display = "flex";
}

document.addEventListener("DOMContentLoaded", () => {
  initCharts();
  loadData();

  document.querySelectorAll(".chart-filter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".chart-filter-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      filterLineChart(btn.dataset.range);
    });
  });

  document.getElementById("nav-dashboard").addEventListener("click", () => {
    document.getElementById("nav-dashboard").classList.add("active");
    document.getElementById("nav-grants").classList.remove("active");
    document.getElementById("stats").style.display = "flex";
    document.getElementById("chartsRow").style.display = "flex";
    document.getElementById("filtersBar").style.display = "flex";
    document.getElementById("grantsGrid").classList.remove("full-width");
    document.querySelector(".main").insertBefore(document.getElementById("filtersBar"), document.getElementById("grantsCount"));
  });

  document.getElementById("nav-grants").addEventListener("click", () => {
    document.getElementById("nav-grants").classList.add("active");
    document.getElementById("nav-dashboard").classList.remove("active");
    document.getElementById("stats").style.display = "none";
    document.getElementById("chartsRow").style.display = "none";
    document.getElementById("filtersBar").style.display = "flex";
    document.getElementById("grantsGrid").classList.add("full-width");
    document.querySelector(".main").insertBefore(document.getElementById("filtersBar"), document.getElementById("grantsCount"));
  });

  document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      if (btn.dataset.status) {
        document.querySelectorAll(".filter-btn[data-status]").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentStatusFilter = btn.dataset.status;
      }
      if (btn.dataset.size) {
        document.querySelectorAll(".filter-btn[data-size]").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentSizeFilter = btn.dataset.size;
      }
      renderGrants(document.getElementById("search").value.toLowerCase());
    });
  });

  document.getElementById("sortSelect").addEventListener("change", e => {
    currentSort = e.target.value;
    renderGrants(document.getElementById("search").value.toLowerCase());
  });

  document.getElementById("search").addEventListener("input", e => {
    renderGrants(e.target.value.toLowerCase());
  });
});

document.querySelector(".close-btn").onclick = () => document.getElementById("grantModal").style.display = "none";
document.getElementById("grantModal").onclick = e => { if (e.target.id === "grantModal") document.getElementById("grantModal").style.display = "none"; };
document.addEventListener("keydown", e => { if (e.key === "Escape") document.getElementById("grantModal").style.display = "none"; });
</script>
</body>
</html>
